# TON USDT 充值功能实现指南

> ⚠️ **注意：此文档和相关代码当前未激活，仅作为参考保留**
> 
> 如需使用充值功能，需要：
> 1. 更新 `recharge-service.ts` 以适配新的组件结构（TelegramWalletManager）
> 2. 确保后端 API 接口已准备好
> 3. 在 `Topup.ts` 中集成充值服务

## 一、需要准备的内容

### 1. **后端 API 接口**

需要后端提供以下接口：

#### 1.1 创建充值订单
```
POST /api/topup/create-order
请求体：
{
  "userId": number,
  "topupId": number,  // 充值套餐ID（对应 TopupContent.identifier）
  "amount": number,   // USDT 金额
  "walletAddress": string  // 用户钱包地址
}

响应：
{
  "orderId": string,      // 订单号
  "receiveAddress": string,  // 收款地址（你的项目钱包地址）
  "amount": number,       // 需要支付的 USDT 金额
  "expireTime": number    // 订单过期时间（时间戳）
}
```

#### 1.2 查询订单状态
```
GET /api/topup/order-status?orderId=xxx

响应：
{
  "orderId": string,
  "status": "pending" | "paid" | "expired" | "failed",
  "txHash": string,      // 交易哈希（如果已支付）
  "paidAmount": number,  // 实际支付金额
  "paidTime": number    // 支付时间（时间戳）
}
```

#### 1.3 确认充值（可选，也可以后端自动处理）
```
POST /api/topup/confirm
请求体：
{
  "orderId": string,
  "txHash": string  // 交易哈希
}
```

### 2. **收款钱包地址**

你需要准备一个 TON 钱包地址用于接收 USDT：
- **收款地址**：你的项目钱包地址（用于接收用户转账的 USDT）
- **USDT Jetton 地址**：`EQCxE6mUtQJKFnGfaROTKOt1lZbDiiX1kCixRv7Nw2Id_sDs`（TON 主网）

### 3. **前端功能模块**

需要实现以下功能：

#### 3.1 订单管理
- 创建订单
- 存储订单信息（订单号、金额、收款地址、过期时间）
- 查询订单状态

#### 3.2 交易监听
- 监听链上交易
- 验证交易是否成功
- 检查交易金额是否匹配

#### 3.3 支付流程
- 生成支付二维码或支付链接
- 引导用户完成支付
- 显示支付状态

## 二、实现步骤

### 步骤 1：创建充值订单服务

创建一个新的服务类来处理充值相关逻辑。

### 步骤 2：集成 TON Connect 支付

使用 TON Connect SDK 发送 USDT Jetton 转账交易。

### 步骤 3：监听交易状态

定期查询订单状态，或使用 WebSocket 实时监听。

### 步骤 4：更新用户余额

支付成功后，后端自动更新用户余额，前端刷新显示。

## 三、技术要点

### 1. USDT Jetton 转账

在 TON 区块链上，USDT 是作为 Jetton（代币）存在的。转账需要使用 Jetton Transfer 操作。

### 2. 交易验证

- 验证交易哈希
- 验证发送地址（用户钱包地址）
- 验证接收地址（你的收款地址）
- 验证金额是否匹配
- 验证交易时间是否在订单有效期内

### 3. 订单超时处理

- 设置订单过期时间（建议 15-30 分钟）
- 超时后取消订单
- 提示用户重新创建订单

## 四、安全注意事项

1. **金额验证**：后端必须验证实际支付金额是否与订单金额一致
2. **地址验证**：验证交易发送地址是否为订单创建时的用户地址
3. **防重放攻击**：每个订单号只能使用一次
4. **时间验证**：验证交易时间是否在订单有效期内
5. **链上验证**：后端应该直接查询链上数据验证交易，而不是仅依赖前端数据

## 五、用户体验优化

1. **支付状态显示**：实时显示支付状态（等待支付、支付中、支付成功、支付失败）
2. **倒计时显示**：显示订单剩余有效时间
3. **支付指引**：提供清晰的支付步骤说明
4. **自动刷新**：支付成功后自动刷新用户余额
5. **错误提示**：支付失败时提供明确的错误信息

## 六、测试要点

1. **正常流程**：创建订单 → 支付 → 确认 → 更新余额
2. **金额不足**：用户 USDT 余额不足时的处理
3. **订单超时**：订单过期后的处理
4. **重复支付**：防止同一订单重复支付
5. **网络异常**：网络中断时的处理

## 七、推荐实现方案

### 方案 A：使用 TON Connect 直接转账（推荐）

优点：
- 用户体验好，直接在钱包中确认
- 安全性高，由钱包应用处理
- 无需二维码

缺点：
- 需要用户安装支持 TON Connect 的钱包
- 需要处理钱包连接状态

### 方案 B：生成支付链接/二维码

优点：
- 兼容性好，支持所有钱包
- 可以离线支付

缺点：
- 需要用户手动复制地址和金额
- 用户体验较差

## 八、下一步

1. 确认后端 API 接口设计
2. 准备收款钱包地址
3. 实现订单创建功能
4. 实现支付功能
5. 实现交易监听功能
6. 测试完整流程

